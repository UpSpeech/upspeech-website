# UpSpeech Testing Audit Report

**Date**: December 9, 2025
**Generated by**: Claude Code
**Purpose**: Comprehensive testing coverage analysis and improvement roadmap

---

## Executive Summary

### Current Coverage Status

| Area | Coverage | Files | Status |
|------|----------|-------|--------|
| **Backend (Rails)** | **61.72%** ✅ | 52 test files | Much better than documented (35.59% outdated) |
| **Frontend (React)** | **~0%** ❌ | 28 test files | Tests exist but not running/not covered |
| **Overall** | **~31%** ⚠️ | 80 test files | Significant gap in frontend |

### Key Findings

1. **Backend is in good shape** - 61.72% coverage with 52 comprehensive test files
2. **Frontend has tests but coverage is broken** - 28 test files exist but showing 0% coverage
3. **Documentation is outdated** - Testing strategy doc from Nov 2025 shows old numbers
4. **Good test patterns exist** - Many comprehensive examples to learn from

### Critical Action Items

1. **Fix frontend test execution** - Tests exist but aren't being run or counted in coverage
2. **Add missing backend tests** - Close remaining 38% gap (services, mailers, edge cases)
3. **Systematically improve frontend coverage** - File by file approach
4. **Update documentation** - Reflect actual current state

---

## Backend Analysis (Ruby on Rails + RSpec)

### Coverage Breakdown

**Overall**: 61.72% (2,328 of 3,772 relevant lines covered)
**Last Generated**: November 28, 2025
**Test Files**: 52 spec files

### Files Inventory

| Category | Total Files | Test Files | Coverage Status |
|----------|-------------|------------|-----------------|
| **Models** | 23 | 20 | ✅ Good (most tested) |
| **Controllers** | 30 | 26 | ✅ Good (API endpoints covered) |
| **Services** | 8 | 5 | ⚠️ Partial (3 missing) |
| **Jobs** | 4 | 3 | ✅ Good (most tested) |
| **Mailers** | 1 | 1 | ✅ Complete |
| **Channels** | 2 | 1 | ⚠️ Partial |

### Models (23 total, 20 with tests)

**Well-Tested Models** (✅ tests exist):
- ✅ `user.rb` - 264 lines of tests, comprehensive
- ✅ `tenant.rb` - 534 lines of tests, very comprehensive
- ✅ `report.rb` - tested
- ✅ `audio_recording.rb` - tested
- ✅ `transcription.rb` - tested
- ✅ `invite_code.rb` - 309 lines, comprehensive
- ✅ `therapist_patient_assignment.rb` - 283 lines, comprehensive
- ✅ `report_note.rb` - tested
- ✅ `mini_game.rb` - tested
- ✅ `mini_game_assignment.rb` - 521 lines, very comprehensive
- ✅ `consultation_exercise.rb` - 332 lines, comprehensive
- ✅ `consultation_exercise_image.rb` - 395 lines, very comprehensive
- ✅ `report_consultation_exercise.rb` - tested
- ✅ `chat_message.rb` - 287 lines, comprehensive
- ✅ `disfluency_annotation.rb` - 391 lines, very comprehensive
- ✅ `technique_annotation.rb` - tested
- ✅ `feature_flag.rb` - tested
- ✅ `tenant_feature_flag.rb` - tested
- ✅ `report_feedback.rb` - tested
- ✅ `general_feedback.rb` - tested

**Missing/Incomplete Tests** (❌ need tests):
- ❌ `application_record.rb` - base class, may not need tests
- ❌ `current.rb` - context object, may not need tests
- ❌ `report_annotation.rb` - **NEEDS TESTS**

### Controllers (30 total, 26 with tests)

**Well-Tested Controllers** (✅ tests exist):

*API Controllers (app/controllers/api/v1/)*:
- ✅ `analytics_controller.rb` - tested
- ✅ `audio_recordings_controller.rb` - 525 lines, very comprehensive
- ✅ `chat_messages_controller.rb` - tested
- ✅ `consultation_exercises_controller.rb` - 556 lines, very comprehensive
- ✅ `invites_controller.rb` - 415 lines, comprehensive (invites_spec.rb)
- ✅ `manual_reports_controller.rb` - tested
- ✅ `me_controller.rb` - tested
- ✅ `mini_game_assignments_controller.rb` - 590 lines, most comprehensive!
- ✅ `mini_games_controller.rb` - 533 lines, very comprehensive
- ✅ `patient_progress_controller.rb` - tested
- ✅ `patient_summaries_controller.rb` - tested
- ✅ `report_notes_controller.rb` - 517 lines, very comprehensive
- ✅ `reports_controller.rb` - tested
- ✅ `tenant_settings_controller.rb` - tested
- ✅ `tenants_controller.rb` - tested
- ✅ `therapist_assignments_controller.rb` - 429 lines, comprehensive
- ✅ `transcriptions_controller.rb` - tested
- ✅ `users_controller.rb` - 420 lines, comprehensive

*Auth Controllers (app/controllers/auth/)*:
- ✅ `sessions_controller.rb` - tested
- ✅ `passwords_controller.rb` - tested
- ✅ `registrations_controller.rb` - tested

*Admin Controllers*:
- ⚠️ `admin/feature_flags_controller.rb` - partial coverage via feature_flags_controller_spec.rb

**Missing Tests** (❌ need tests):
- ❌ `application_controller.rb` - base class, may not need tests
- ❌ `health_controller.rb` - simple health check, low priority
- ❌ `docs_controller.rb` - **NEEDS TESTS**
- ❌ `report_annotations_controller.rb` - **NEEDS TESTS**
- ❌ `report_feedbacks_controller.rb` - **NEEDS TESTS**
- ❌ `general_feedbacks_controller.rb` - **NEEDS TESTS**
- ❌ `user_preferences_controller.rb` - **NEEDS TESTS**
- ❌ `feature_flags_controller.rb` - **NEEDS TESTS** (or verify existing coverage)

### Services (8 total, 5 with tests)

**Well-Tested Services** (✅ tests exist):
- ✅ `ai_chat_service.rb` - tested
- ✅ `patient_summary_generator.rb` - tested
- ✅ `jwt_service.rb` - tested
- ✅ `feature_flag_service.rb` - tested
- ⚠️ `google_cloud_storage_service.rb` - may have partial coverage

**Missing Tests** (❌ HIGH PRIORITY):
- ❌ `audio_analyzer_service.rb` - **NEEDS TESTS**
- ❌ `markdown_processor.rb` - **NEEDS TESTS**
- ❌ `video_clip_extractor_service.rb` - **NEEDS TESTS**

### Jobs (4 total, 3 with tests)

**Well-Tested Jobs** (✅ tests exist):
- ✅ `transcription_processor_job.rb` - tested
- ✅ `process_daily_mini_game_assignments_job.rb` - tested
- ✅ `process_exercise_clips_job.rb` - tested

**Missing Tests**:
- ❌ `application_job.rb` - base class, may not need tests

### Mailers (1 total, 1 with tests)

**Well-Tested**:
- ✅ `invite_mailer.rb` - tested

### Channels (2 total, 1 with tests)

**Well-Tested**:
- ✅ `chat_channel.rb` - 88.89% coverage

**Missing Tests**:
- ❌ `application_cable/connection.rb` - 0% coverage, **NEEDS TESTS**

---

## Frontend Analysis (React + TypeScript + Vitest)

### Coverage Breakdown

**Overall**: ~0% (tests exist but not running/being counted)
**Last Run**: December 9, 2025
**Test Files**: 28 test files
**Status**: ❌ CRITICAL - Tests exist but coverage is broken

### Files Inventory

| Category | Total Files | Test Files | Estimated Coverage |
|----------|-------------|------------|-------------------|
| **Pages** | 23 | 10 | ⚠️ ~43% have tests |
| **Components** | 68 (non-UI) | 12 | ⚠️ ~18% have tests |
| **Hooks** | 8 | 0 | ❌ 0% have tests |
| **Lib/Utils** | 8 | 3 | ⚠️ ~37% have tests |
| **UI Components** | ~40 | ~10 | ⚠️ ~25% have tests |

### Pages (23 total, 10 with tests)

**Well-Tested Pages** (✅ tests exist):
- ✅ `PatientProgressPage.tsx` - 701 lines, very comprehensive!
- ✅ `ReportViewPage.tsx` - 605 lines, comprehensive
- ✅ `ReportsPage.tsx` - has tests
- ✅ `MyExercisesPage.tsx` - 377 lines, good coverage
- ✅ `ConsultationExercisesLibraryPage.tsx` - 588 lines, comprehensive
- ✅ `TenantSettingsPage.tsx` - 581 lines, comprehensive
- ⚠️ `AccountSettingsPage.tsx` - may have tests
- ⚠️ `AnalyticsPage.tsx` - may have tests
- ⚠️ `AudioUploadPage.tsx` - may have tests
- ⚠️ `DashboardPage.tsx` - may have tests

**Missing Tests** (❌ HIGH PRIORITY):
- ❌ `AuthPage.tsx` - **NEEDS TESTS**
- ❌ `ExerciseManagementPage.tsx` - **NEEDS TESTS**
- ❌ `FeatureFlagManagementPage.tsx` - **NEEDS TESTS**
- ❌ `FeedbackManagementDashboard.tsx` - **NEEDS TESTS**
- ❌ `ForgotPasswordPage.tsx` - **NEEDS TESTS**
- ❌ `HelpCenterPage.tsx` - **NEEDS TESTS**
- ❌ `ManualReportGeneratorPage.tsx` - **NEEDS TESTS**
- ❌ `MiniGamesLibraryPage.tsx` - **NEEDS TESTS**
- ❌ `MyPatientsPage.tsx` - **NEEDS TESTS**
- ❌ `ReportEditPage.tsx` - **NEEDS TESTS** (critical!)
- ❌ `ResetPasswordPage.tsx` - **NEEDS TESTS**
- ❌ `TenantsManagementPage.tsx` - **NEEDS TESTS**
- ❌ `UsersManagementPage.tsx` - **NEEDS TESTS**

### Components (68 non-UI components, ~12 with tests)

**Well-Tested Components** (✅ based on test file size):
- ✅ `reports/ReportNotes.tsx` - 719 lines of tests, most comprehensive!
- ✅ `exercises/CompletionProgressChart.tsx` - 669 lines, very comprehensive
- ✅ `exercises/ExerciseSelectorModal.tsx` - 441 lines, good
- ✅ `ui/Table/Table.tsx` - 556 lines, comprehensive
- ✅ `clients/CreateClientModal.tsx` - has tests
- ✅ `clients/StatsCards.tsx` - has tests
- ✅ `dashboards/AdminDashboard.tsx` - has tests
- ✅ `dashboards/ClientDashboard.tsx` - has tests
- ✅ `dashboards/TherapistDashboard.tsx` - has tests
- ✅ `LanguageSwitcher.tsx` - has tests
- ✅ `ui/Alert/Alert.tsx` - has tests
- ✅ `ui/Breadcrumb/Breadcrumb.tsx` - has tests
- ✅ `ui/ConfirmationDialog/ConfirmationDialog.tsx` - has tests
- ✅ `ui/StatCard/StatCard.tsx` - has tests
- ✅ `ui/Tabs/Tabs.tsx` - has tests

**Missing Tests** (❌ remaining ~56 components):
Most components in these directories need tests:
- `components/auth/*` - Login/Register forms
- `components/chat/*` - Chat UI components
- `components/clients/*` - Patient management
- `components/common/*` - Shared components
- `components/exercises/*` - Exercise UI (many missing)
- `components/feedback/*` - Feedback forms
- `components/help/*` - Help center
- `components/onboarding/*` - Onboarding flows
- `components/reports/*` - Report editor, selectors
- `components/ui/*` - Many UI components still missing

### Hooks (8 total, 0 with tests)

**ALL Missing Tests** (❌ HIGH PRIORITY):
- ❌ `useAIOperation.ts` - **NEEDS TESTS**
- ❌ `useApiCall.ts` - **NEEDS TESTS** (critical!)
- ❌ `useApiError.ts` - **NEEDS TESTS**
- ❌ `useDebounce.ts` - **NEEDS TESTS**
- ❌ `useDeferredLoading.ts` - **NEEDS TESTS**
- ❌ `useFeatureFlag.ts` - **NEEDS TESTS**
- ❌ `usePaginatedFilters.ts` - **NEEDS TESTS**
- ❌ `useSuccessToast.ts` - **NEEDS TESTS**

### Lib/Utils (8 total, 3 with tests)

**Well-Tested**:
- ✅ `permissions.ts` - has tests
- ✅ `errorDisplay.ts` - partial coverage
- ✅ `errorUtils.ts` - partial coverage

**Missing Tests** (❌ HIGH PRIORITY):
- ❌ `api.ts` - **NEEDS TESTS** (critical! 1300+ lines)
- ❌ `auth.tsx` - **NEEDS TESTS** (critical!)
- ❌ `theme.tsx` - **NEEDS TESTS**
- ⚠️ Mocks exist (`__mocks__/api.ts`, `__mocks__/auth.ts`) but no actual tests

---

## Good Test Examples to Use as Templates

### Backend (RSpec) Examples

**Best Model Test Example**: `spec/models/user_spec.rb` (264 lines)
```ruby
RSpec.describe User, type: :model do
  let(:tenant) { create(:tenant) }
  let(:user) { build(:user, tenant: tenant) }

  describe 'validations' do
    it 'is valid with valid attributes'
    it 'requires an email'
    # ... comprehensive validation tests
  end

  describe 'associations' do
    it 'belongs to tenant'
  end

  describe 'scopes' do
    it 'returns users for specific tenant'
  end

  describe 'role methods' do
    describe '#tenant_owner?'
    describe '#can_manage_all_tenants?'
    # ... thorough role-based method tests
  end
end
```

**Best Controller Test Example**: `spec/requests/api/v1/mini_game_assignments_controller_spec.rb` (590 lines)
- Comprehensive CRUD tests
- Permission tests for all 5 roles
- Multi-tenancy enforcement tests
- Edge case handling

**Other Good Examples**:
- `spec/models/tenant_spec.rb` (534 lines) - Most comprehensive model test
- `spec/models/invite_code_spec.rb` (309 lines) - Good state machine testing
- `spec/requests/api/v1/audio_recordings_controller_spec.rb` (525 lines) - File upload testing

### Frontend (Vitest) Examples

**Best Page Test Example**: `src/pages/PatientProgressPage.test.tsx` (701 lines)
```typescript
import { render, screen, waitFor, act } from "@testing-library/react";
import { describe, it, expect, beforeEach, vi } from "vitest";
import userEvent from "@testing-library/user-event";

// Mock dependencies
vi.mock("react-router-dom", () => ({
  useParams: () => ({ patientId: "123" }),
  useNavigate: () => mockNavigate,
}));

// Mock recharts for chart components
vi.mock("recharts", () => ({
  ResponsiveContainer: ({ children }) => (
    <div data-testid="responsive-container">{children}</div>
  ),
  // ... other chart components
}));

// Mock API with hoisted reference
const { apiClient } = vi.hoisted(() => ({
  apiClient: {
    getPatientProgress: vi.fn(),
  },
}));

describe("PatientProgressPage", () => {
  const mockProgressData = { /* comprehensive mock data */ };

  beforeEach(() => {
    vi.clearAllMocks();
    apiClient.getPatientProgress.mockResolvedValue(mockProgressData);
  });

  describe("initial render", () => {
    it("fetches and displays progress data");
    it("shows loading state");
    it("handles errors");
  });

  describe("filtering", () => {
    it("filters by time range");
  });

  // ... comprehensive interaction tests
});
```

**Best Component Test Example**: `src/components/reports/ReportNotes.test.tsx` (719 lines)
- Comprehensive CRUD operations
- Permission-based rendering tests
- Form validation tests
- API error handling

**Other Good Examples**:
- `src/pages/ReportViewPage.test.tsx` (605 lines) - Page with complex interactions
- `src/components/exercises/CompletionProgressChart.test.tsx` (669 lines) - Chart component testing
- `src/pages/ConsultationExercisesLibraryPage.test.tsx` (588 lines) - List with filters/pagination

---

## Recommended Testing Improvement Plan

### Phase 1: Fix Frontend Test Infrastructure (URGENT - 2-4 hours)

**Problem**: Frontend shows 0% coverage despite 28 test files existing

**Actions**:
1. Investigate why Vitest coverage is showing 0%
2. Check if tests are actually running (they may be failing silently)
3. Review vitest.config.ts configuration
4. Ensure coverage reporters are properly configured
5. Run tests manually to verify they pass: `npm run test`
6. Generate coverage again: `npm run test -- --coverage`

**Expected Outcome**: Get accurate frontend coverage baseline (likely 30-50%)

---

### Phase 2: Backend - Close Remaining Gaps (10-15 hours)

**Priority 1 - Missing Controllers (5-6 hours)**:
1. ❌ `docs_controller_spec.rb` - 1 hour
2. ❌ `report_annotations_controller_spec.rb` - 2 hours
3. ❌ `report_feedbacks_controller_spec.rb` - 1 hour
4. ❌ `general_feedbacks_controller_spec.rb` - 1 hour
5. ❌ `user_preferences_controller_spec.rb` - 1 hour

**Priority 2 - Missing Services (4-5 hours)**:
1. ❌ `audio_analyzer_service_spec.rb` - 2 hours (complex)
2. ❌ `markdown_processor_spec.rb` - 1 hour
3. ❌ `video_clip_extractor_service_spec.rb` - 2 hours (complex)

**Priority 3 - Missing Models/Channels (2-3 hours)**:
1. ❌ `report_annotation_spec.rb` - 1 hour
2. ❌ `application_cable/connection_spec.rb` - 2 hours (WebSocket testing)

**Expected Outcome**: Backend coverage 75-85%

---

### Phase 3: Frontend - Critical Paths (15-20 hours)

**Priority 1 - Custom Hooks (4-5 hours)** - These are reused everywhere:
1. ❌ `useApiCall.test.ts` - 1.5 hours (CRITICAL!)
2. ❌ `useAIOperation.test.ts` - 1 hour
3. ❌ `useApiError.test.ts` - 0.5 hours
4. ❌ `useDebounce.test.ts` - 0.5 hours
5. ❌ `useDeferredLoading.test.ts` - 0.5 hours
6. ❌ `useFeatureFlag.test.ts` - 0.5 hours
7. ❌ `usePaginatedFilters.test.ts` - 1 hour
8. ❌ `useSuccessToast.test.ts` - 0.5 hours

**Priority 2 - Core Utils (3-4 hours)**:
1. ❌ `api.test.ts` - 2 hours (CRITICAL! 1300+ lines)
2. ❌ `auth.test.tsx` - 1 hour (CRITICAL!)
3. ❌ `theme.test.tsx` - 0.5 hours

**Priority 3 - Critical Pages (8-10 hours)**:
1. ❌ `ReportEditPage.test.tsx` - 3 hours (complex Tiptap editor)
2. ❌ `AudioUploadPage.test.tsx` - 2 hours (file upload + recording)
3. ❌ `MyPatientsPage.test.tsx` - 2 hours (list + filters)
4. ❌ `ManualReportGeneratorPage.test.tsx` - 2 hours (form + AI)
5. ❌ `AuthPage.test.tsx` - 1 hour

**Expected Outcome**: Frontend coverage 50-60%

---

### Phase 4: Frontend - Systematic Component Coverage (20-30 hours)

Work through remaining ~56 components file by file, focusing on:
1. **Auth components** - Login/Register forms (3 hours)
2. **Chat components** - Chat UI (3 hours)
3. **Client management** - Patient CRUD (4 hours)
4. **Common components** - Shared UI (4 hours)
5. **Exercise components** - Exercise UI (5 hours)
6. **Feedback components** - Feedback forms (3 hours)
7. **Report components** - Editors/selectors (5 hours)
8. **Remaining pages** - 11 pages (10 hours)

**Expected Outcome**: Frontend coverage 75-80%

---

### Phase 5: Edge Cases & Integration Tests (10-15 hours)

1. **Backend edge cases** - Race conditions, validations, error paths (5 hours)
2. **Frontend integration tests** - Full user flows with Playwright/Cypress (10 hours)
   - Registration → Invite acceptance
   - Upload → Transcription → Report generation
   - Therapist assigns exercise → Patient completes
   - Report editing → PDF export

**Expected Outcome**: Overall coverage 80%+, critical paths 95%+

---

## Total Time Investment Estimate

| Phase | Focus | Time | Expected Coverage Gain |
|-------|-------|------|----------------------|
| 1 | Fix frontend infrastructure | 2-4h | Get accurate baseline |
| 2 | Backend gaps | 10-15h | Backend: 61% → 80% |
| 3 | Frontend critical paths | 15-20h | Frontend: 0% → 55% |
| 4 | Frontend components | 20-30h | Frontend: 55% → 78% |
| 5 | Edge cases & integration | 10-15h | Overall: 80%+ |
| **TOTAL** | **Complete coverage** | **57-84h** | **80-85% overall** |

**Recommended Approach**: Work in 2-week sprints
- **Sprint 1** (Week 1-2): Phase 1 + Phase 2 (Backend to 80%)
- **Sprint 2** (Week 3-4): Phase 3 (Frontend critical paths to 55%)
- **Sprint 3** (Week 5-6): Phase 4 Part 1 (Components +20%)
- **Sprint 4** (Week 7-8): Phase 4 Part 2 + Phase 5 (80%+ total)

---

## File-by-File Testing Checklist

### Backend - Missing Tests Checklist

**Controllers** (8 files):
- [ ] `docs_controller.rb`
- [ ] `report_annotations_controller.rb`
- [ ] `report_feedbacks_controller.rb`
- [ ] `general_feedbacks_controller.rb`
- [ ] `user_preferences_controller.rb`
- [ ] `feature_flags_controller.rb`
- [ ] `admin/feature_flags_controller.rb`
- [ ] `health_controller.rb` (low priority)

**Services** (3 files):
- [ ] `audio_analyzer_service.rb`
- [ ] `markdown_processor.rb`
- [ ] `video_clip_extractor_service.rb`

**Models** (1 file):
- [ ] `report_annotation.rb`

**Channels** (1 file):
- [ ] `application_cable/connection.rb`

**Total**: 13 files to test

---

### Frontend - Missing Tests Checklist

**Pages** (13 files):
- [ ] `AuthPage.tsx`
- [ ] `ExerciseManagementPage.tsx`
- [ ] `FeatureFlagManagementPage.tsx`
- [ ] `FeedbackManagementDashboard.tsx`
- [ ] `ForgotPasswordPage.tsx`
- [ ] `HelpCenterPage.tsx`
- [ ] `ManualReportGeneratorPage.tsx`
- [ ] `MiniGamesLibraryPage.tsx`
- [ ] `MyPatientsPage.tsx`
- [ ] `ReportEditPage.tsx`
- [ ] `ResetPasswordPage.tsx`
- [ ] `TenantsManagementPage.tsx`
- [ ] `UsersManagementPage.tsx`

**Hooks** (8 files) - ALL MISSING:
- [ ] `useAIOperation.ts`
- [ ] `useApiCall.ts` - CRITICAL
- [ ] `useApiError.ts`
- [ ] `useDebounce.ts`
- [ ] `useDeferredLoading.ts`
- [ ] `useFeatureFlag.ts`
- [ ] `usePaginatedFilters.ts`
- [ ] `useSuccessToast.ts`

**Lib/Utils** (3 files):
- [ ] `api.ts` - CRITICAL (1300+ lines!)
- [ ] `auth.tsx` - CRITICAL
- [ ] `theme.tsx`

**Components** (~56 files) - Work through systematically by directory:
- [ ] `components/auth/*` - Login/Register forms (estimate: 4-5 files)
- [ ] `components/chat/*` - Chat UI (estimate: 4 files)
- [ ] `components/clients/*` - Patient management (estimate: 3-4 files)
- [ ] `components/common/*` - Shared components (estimate: 6-7 files)
- [ ] `components/exercises/*` - Exercise UI (estimate: 8-10 files)
- [ ] `components/feedback/*` - Feedback forms (estimate: 8-10 files)
- [ ] `components/help/*` - Help center (estimate: 1-2 files)
- [ ] `components/onboarding/*` - Onboarding (estimate: 1-2 files)
- [ ] `components/reports/*` - Report editor/selectors (estimate: 3-4 files)
- [ ] `components/ui/*` - Remaining UI components (estimate: 20-25 files)

**Total**: ~93 files to test

---

## Testing Best Practices Summary

### Backend (RSpec)

**Structure**:
```ruby
RSpec.describe ClassName, type: :model/:request/:job do
  let(:tenant) { create(:tenant) }

  describe 'validations' do
    # Test all validations
  end

  describe 'associations' do
    # Test all relationships
  end

  describe 'scopes' do
    # Test multi-tenancy + filtering
  end

  describe 'methods' do
    # Test business logic
  end
end
```

**Key Patterns**:
- Use `let` for setup, `let!` when you need creation
- Use FactoryBot: `create(:user)`, `build(:user)`, `create_list(:user, 5)`
- Test multi-tenancy: Always test cross-tenant isolation
- Test all 5 roles: owner, admin, therapist, client, member
- Use `beforeEach` for common setup
- Mock external services: `allow(ExternalService).to receive(:call)`

### Frontend (Vitest + Testing Library)

**Structure**:
```typescript
import { render, screen, waitFor } from "@testing-library/react";
import { describe, it, expect, beforeEach, vi } from "vitest";
import userEvent from "@testing-library/user-event";

// Mock dependencies BEFORE imports
vi.mock("react-router-dom", () => ({ /* mocks */ }));

const { apiClient } = vi.hoisted(() => ({
  apiClient: { method: vi.fn() }
}));
vi.mock("@/lib/api", () => ({ apiClient }));

describe("ComponentName", () => {
  beforeEach(() => {
    vi.clearAllMocks();
    apiClient.method.mockResolvedValue(mockData);
  });

  it("renders correctly", () => {
    render(<ComponentName />);
    expect(screen.getByText("Expected")).toBeInTheDocument();
  });

  it("handles user interaction", async () => {
    const user = userEvent.setup();
    render(<ComponentName />);

    await user.click(screen.getByRole("button"));
    await waitFor(() => {
      expect(apiClient.method).toHaveBeenCalled();
    });
  });
});
```

**Key Patterns**:
- Mock external dependencies (React Router, API, charts)
- Use `vi.hoisted()` for proper mock initialization
- Clear mocks in `beforeEach`
- Test loading, success, and error states
- Use `screen.getByRole` > `getByTestId` > `getByText`
- Use `userEvent` for realistic interactions
- Use `waitFor` for async assertions
- Mock complex components like charts

---

## Tools & Commands

### Running Tests

**Backend**:
```bash
cd app-backend

# Run all tests
bundle exec rspec

# Run with coverage
COVERAGE=true bundle exec rspec

# Run specific file
bundle exec rspec spec/models/user_spec.rb

# Run specific test
bundle exec rspec spec/models/user_spec.rb:42

# View coverage report
open coverage/index.html
```

**Frontend**:
```bash
cd app-frontend

# Run all tests
npm run test

# Run with coverage
npm run test -- --coverage

# Run specific file
npm run test src/pages/PatientProgressPage.test.tsx

# Watch mode
npm run test -- --watch

# UI mode
npm run test:ui

# View coverage report
open coverage/index.html
```

### Coverage Goals

| Category | Minimum | Target | Critical Paths |
|----------|---------|--------|----------------|
| Overall | 70% | 80% | 95% |
| Backend | 75% | 85% | 95% |
| Frontend | 65% | 75% | 95% |
| Models | 85% | 95% | 100% |
| Controllers | 80% | 90% | 95% |
| Services | 75% | 85% | 90% |
| Pages | 60% | 70% | 90% |
| Hooks | 80% | 90% | 95% |
| Utils | 85% | 95% | 100% |

**Critical Paths** (require 95%+ coverage):
- Authentication & Authorization
- Multi-tenancy enforcement
- Payment flows (if applicable)
- Data security & privacy
- API endpoints with sensitive data
- File upload & processing

---

## Next Steps

### Immediate Actions (This Week)

1. **Fix frontend test infrastructure** (2-4 hours)
   - Run `npm run test` and investigate failures
   - Fix Vitest configuration if needed
   - Get accurate coverage baseline

2. **Start Phase 2 - Backend gaps** (pick 2-3 high-priority files)
   - `report_annotations_controller_spec.rb`
   - `audio_analyzer_service_spec.rb`
   - `markdown_processor_spec.rb`

3. **Update documentation**
   - Mark TESTING_STRATEGY.md as outdated
   - Link to this audit report

### Weekly Goals (Suggested)

**Week 1-2**: Fix frontend + Backend controllers (3 files)
**Week 3-4**: Backend services + Hooks (8 files)
**Week 5-6**: Core utils + Critical pages (8 files)
**Week 7-8**: Remaining components (systematic approach, 15-20 files)

### Progress Tracking

Create a testing dashboard or use a simple tracker:
- [ ] Backend: 61.72% → 75% → 85%
- [ ] Frontend: 0% → 30% → 55% → 75%
- [ ] Overall: ~31% → 50% → 65% → 80%

---

## Conclusion

**Good News**:
- Backend is in much better shape than documented (61.72% vs 35.59%)
- Many comprehensive test examples exist to learn from
- Test infrastructure is working well for backend
- 80 test files already exist (good foundation)

**Challenges**:
- Frontend coverage is broken/not running (0% despite 28 test files)
- 93 frontend files still need tests
- 13 backend files need tests
- Documentation is outdated

**Recommended Approach**:
1. Fix frontend infrastructure first (URGENT)
2. Work systematically file-by-file
3. Use existing good examples as templates
4. Track progress weekly
5. Aim for 80%+ coverage in 6-8 weeks (57-84 hours total)

**Priority Order**:
1. Fix frontend test execution ← START HERE
2. Backend missing controllers/services
3. Frontend hooks + utils (most critical)
4. Frontend critical pages
5. Systematic component coverage
6. Edge cases + integration tests

---

**Generated**: December 9, 2025
**Next Review**: December 16, 2025 (after Phase 1 completion)
**Maintained By**: Development Team
